# Инструкция по развертыванию TimeTracker

## Локальная разработка

### Запуск только базы данных для разработки
```bash
make dev-db
```
Затем запустите backend и frontend локально:
```bash
npm run start
```

### Остановка базы данных для разработки
```bash
make dev-db-down
```

## Полная локальная разработка в Docker

### Запуск всех сервисов
```bash
make dev
```

### Остановка всех сервисов
```bash
make down
```

## Продакшн развертывание

### Первичная настройка

1. **Скопируйте и настройте переменные окружения:**
   ```bash
   cp .env.prod.example .env.prod
   ```

2. **Измените значения в .env.prod:**
   - `DB_PASSWORD` - сильный пароль для базы данных
   - `JWT_SECRET` - секретный ключ для JWT токенов (минимум 32 символа)

### Развертывание

1. **Сборка и запуск в продакшн:**
   ```bash
   make prod-build
   ```

2. **Перезапуск в продакшн (без сборки):**
   ```bash
   make prod
   ```

3. **Остановка продакшн сервисов:**
   ```bash
   make prod-down
   ```

## Архитектура продакшн развертывания

```
Internet → Nginx (Port 80/443) → Backend (Port 3000) / Frontend (Port 80)
                                ↓
                              PostgreSQL (Port 5432)
```

### Компоненты:

- **Nginx** - Reverse proxy, обрабатывает все входящие запросы
- **Frontend** - React приложение (внутренний порт 80)
- **Backend** - NestJS API (внутренний порт 3000)
- **PostgreSQL** - База данных (внутренний порт 5432)
- **Adminer** - Веб-интерфейс для БД (только в dev режиме)

### Маршрутизация:

- `/` - Фронтенд приложение
- `/api/v1/*` - Backend API
- `/health` - Health check
- `/docs` - Swagger документация

## Устранение проблем

### Проблема: Фронтенд отправляет запросы на `/v1/` вместо `/api/v1/`

**Решение:** В docker-compose файлах исправлен `VITE_API_URL` на `/api/v1`

### Проблема: Backend не может подключиться к базе данных

**Решения:**
1. Убедитесь, что база данных запущена и готова
2. Проверьте настройки подключения в `.env` файлах
3. Убедитесь, что контейнеры находятся в одной сети

### Проблема: Порт уже занят

```bash
# Остановите все контейнеры
make down
# Или принудительно очистите
make clean
```

## Мониторинг

### Проверка статуса сервисов:
```bash
make status
```

### Просмотр логов:
```bash
# Все сервисы
make logs

# Конкретный сервис
make logs-backend
make logs-frontend
make logs-db
```

### Health checks:
- Backend: `http://your-domain/health`
- Frontend: `http://your-domain/` (должен загрузиться интерфейс)

## Безопасность

### Продакшн рекомендации:
1. Измените все пароли и секретные ключи по умолчанию
2. Настройте SSL сертификаты в папке `nginx/ssl/`
3. Ограничьте доступ к Adminer (по умолчанию отключен в продакшне)
4. Регулярно обновляйте Docker образы
5. Настройте backup базы данных

### SSL сертификаты:
Поместите сертификаты в `nginx/ssl/` и обновите конфигурацию nginx для HTTPS. 